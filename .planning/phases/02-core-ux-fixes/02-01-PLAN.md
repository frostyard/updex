---
phase: 02-core-ux-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - updex/options.go
  - updex/features.go
  - cmd/commands/features.go
autonomous: true

must_haves:
  truths:
    - "User can run 'updex features enable FEATURE --now' to immediately download extensions"
    - "User can run 'updex features disable FEATURE --now' to immediately remove extension files"
    - "User sees error when disabling merged extension without --force"
    - "User can use --dry-run to preview enable/disable actions without changes"
  artifacts:
    - path: "updex/options.go"
      provides: "EnableFeatureOptions struct with Now, DryRun, Retry fields"
      contains: "type EnableFeatureOptions struct"
    - path: "updex/features.go"
      provides: "EnableFeature accepts options, DisableFeature checks merge state"
      exports: ["EnableFeature", "DisableFeature"]
    - path: "cmd/commands/features.go"
      provides: "CLI flags for --now, --force, --dry-run, --retry"
      contains: "--now"
  key_links:
    - from: "cmd/commands/features.go"
      to: "updex.EnableFeature"
      via: "client.EnableFeature(ctx, name, opts)"
      pattern: "EnableFeature.*EnableFeatureOptions"
    - from: "updex/features.go"
      to: "sysext.GetActiveVersion"
      via: "merge state check"
      pattern: "GetActiveVersion"
---

<objective>
Implement --now flag for features enable (downloads extensions immediately) and fix features disable --now to include file removal with merge state safety checks.

Purpose: Users can enable/disable features with immediate effect instead of waiting for next update cycle. Disabling a feature actually removes files, not just config. Merge state is checked before dangerous operations.
Output: Working enable/disable with --now, --force, --dry-run flags in CLI and library API.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-ux-fixes/02-CONTEXT.md
@.planning/phases/02-core-ux-fixes/02-RESEARCH.md

# Key source files
@updex/options.go
@updex/features.go
@updex/results.go
@updex/update.go
@cmd/commands/features.go
@internal/sysext/manager.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add EnableFeatureOptions and extend EnableFeature with --now</name>
  <files>
    updex/options.go
    updex/features.go
    updex/results.go
    cmd/commands/features.go
  </files>
  <action>
1. In `updex/options.go`, add `EnableFeatureOptions` struct:
   ```go
   type EnableFeatureOptions struct {
       Now        bool // Immediately download extensions after enabling
       DryRun     bool // Preview changes without modifying filesystem
       Retry      bool // Retry on network failures
       RetryCount int  // Number of retries (default 3 if Retry is true)
       NoRefresh  bool // Skip systemd-sysext refresh after download
   }
   ```

2. In `updex/results.go`, extend `FeatureActionResult` to include download info:
   ```go
   // Add to FeatureActionResult:
   DownloadedFiles []string `json:"downloaded_files,omitempty"`
   DryRun          bool     `json:"dry_run,omitempty"`
   ```

3. In `updex/features.go`, change `EnableFeature` signature:
   - FROM: `EnableFeature(ctx context.Context, name string) (*FeatureActionResult, error)`
   - TO: `EnableFeature(ctx context.Context, name string, opts EnableFeatureOptions) (*FeatureActionResult, error)`

4. Implement --now logic in `EnableFeature`:
   - After creating drop-in config, if `opts.Now`:
     - Load transfers for this feature via `config.GetTransfersForFeature`
     - For each transfer, call the download logic (similar to Update method):
       - Get available versions, find newest
       - Download file using `download.Download`
       - Update symlink
       - Track downloaded files in result
     - If `!opts.NoRefresh`, call `sysext.Refresh()`
   - If `opts.DryRun`:
     - Set `result.DryRun = true`
     - Skip actual file operations (drop-in creation, downloads)
     - Still report what WOULD be done
   - Set appropriate `NextActionMessage`:
     - With --now: "Feature 'X' enabled and extensions downloaded."
     - Without --now: "Feature 'X' enabled. Run 'updex update' to download extensions."

5. In `cmd/commands/features.go`:
   - Add package-level vars for new flags:
     ```go
     var (
         featureEnableNow    bool
         featureEnableDryRun bool
         featureEnableRetry  bool
     )
     ```
   - In `newFeaturesEnableCmd()`, add flags:
     ```go
     cmd.Flags().BoolVar(&featureEnableNow, "now", false, "Immediately download extensions")
     cmd.Flags().BoolVar(&featureEnableDryRun, "dry-run", false, "Preview changes without modifying filesystem")
     cmd.Flags().BoolVar(&featureEnableRetry, "retry", false, "Retry on network failures (3 attempts)")
     ```
   - Update `runFeaturesEnable` to construct and pass options:
     ```go
     opts := updex.EnableFeatureOptions{
         Now:       featureEnableNow,
         DryRun:    featureEnableDryRun,
         Retry:     featureEnableRetry,
         NoRefresh: common.NoRefresh,
     }
     result, err := client.EnableFeature(context.Background(), args[0], opts)
     ```
   - Update output messages for --now case

Note: Use existing progress helper methods (`c.helper.BeginTask`, `c.helper.Info`, etc.) for all output.
  </action>
  <verify>
1. `go build ./...` succeeds
2. `go vet ./...` passes
3. `updex features enable --help` shows --now, --dry-run, --retry flags
  </verify>
  <done>
- EnableFeatureOptions struct exists in options.go
- EnableFeature accepts EnableFeatureOptions parameter
- --now flag triggers download of feature's extensions
- --dry-run previews without changes
- CLI help shows new flags
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix DisableFeature --now semantics and add merge state check</name>
  <files>
    updex/options.go
    updex/features.go
    cmd/commands/features.go
  </files>
  <action>
1. In `updex/options.go`, extend `DisableFeatureOptions`:
   ```go
   type DisableFeatureOptions struct {
       Remove    bool // Remove downloaded files (DEPRECATED: --now now includes this)
       Now       bool // Immediately remove files AND unmerge
       Force     bool // Allow removal of merged extensions
       DryRun    bool // Preview changes without modifying filesystem
       NoRefresh bool // Skip systemd-sysext refresh
   }
   ```

2. In `updex/features.go`, modify `DisableFeature`:
   - Add merge state check BEFORE any destructive operations:
     ```go
     // Check merge state for all feature transfers
     if opts.Now || opts.Remove {
         transfers, err := config.LoadTransfers(c.config.Definitions)
         featureTransfers := config.GetTransfersForFeature(transfers, name)
         
         for _, t := range featureTransfers {
             activeVersion, err := sysext.GetActiveVersion(t)
             if err != nil {
                 // Log warning but continue
             }
             if activeVersion != "" && !opts.Force {
                 result.Error = fmt.Sprintf("Extension '%s' is active (version %s). Removing requires --force and a reboot to take effect.", t.Component, activeVersion)
                 return result, fmt.Errorf("%s", result.Error)
             }
         }
     }
     ```
   
   - Change --now behavior:
     - OLD: `--now` only unmerges, `--remove` only removes files
     - NEW: `--now` does BOTH (unmerge AND remove files)
     - Keep `--remove` for backward compat but treat it same as `--now`
   
   - If `opts.DryRun`:
     - Set `result.DryRun = true`
     - Skip actual operations
     - Report what WOULD be done (which files would be removed)
   
   - Update NextActionMessage based on what was done:
     - With --now and --force on merged: "Feature disabled and files removed. Reboot required for changes to take effect."
     - With --now (not merged): "Feature 'X' disabled and extensions removed."
     - Without --now: "Feature 'X' disabled. Run 'updex update' to apply changes."

3. In `cmd/commands/features.go`:
   - Add new flag vars:
     ```go
     var (
         featureDisableRemove bool  // existing
         featureDisableNow    bool  // existing
         featureDisableForce  bool  // NEW
         featureDisableDryRun bool  // NEW
     )
     ```
   - In `newFeaturesDisableCmd()`, add flags:
     ```go
     cmd.Flags().BoolVar(&featureDisableForce, "force", false, "Allow removal of merged extensions (requires reboot)")
     cmd.Flags().BoolVar(&featureDisableDryRun, "dry-run", false, "Preview changes without modifying filesystem")
     ```
   - Update long description to explain new --now behavior
   - Update `runFeaturesDisable` to pass new options

4. Update CLI output for disable:
   - Show list of files that would be/were removed
   - Show warning about reboot when --force is used
  </action>
  <verify>
1. `go build ./...` succeeds
2. `go vet ./...` passes  
3. `updex features disable --help` shows --now, --remove, --force, --dry-run flags
4. `golangci-lint run` passes (or only has pre-existing warnings)
  </verify>
  <done>
- --now flag on disable removes files AND unmerges (combined behavior)
- Merge state checked before removal, requires --force for merged extensions
- --dry-run shows what would happen without changes
- --force flag documented and shows reboot warning
- Backward compat: --remove still works (same as --now)
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

```bash
# Build succeeds
go build ./...

# Tests pass (existing tests)
go test ./...

# Linting passes
golangci-lint run

# CLI help is correct
updex features enable --help  # Shows --now, --dry-run, --retry
updex features disable --help # Shows --now, --force, --dry-run, --remove

# Code compiles and API is correct
go vet ./...
```
</verification>

<success_criteria>
1. EnableFeature accepts EnableFeatureOptions with Now, DryRun, Retry fields
2. EnableFeature with --now downloads extensions immediately after enabling
3. DisableFeature with --now both unmerges AND removes files
4. DisableFeature checks merge state and requires --force for merged extensions
5. Both commands support --dry-run for preview
6. All existing tests pass
7. CI checks pass (lint, vet, build)
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-ux-fixes/02-01-SUMMARY.md`
</output>
