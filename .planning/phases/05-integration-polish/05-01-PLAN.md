---
phase: 05-integration-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - updex/integration_test.go
autonomous: true

must_haves:
  truths:
    - "Integration tests validate complete install workflow"
    - "Integration tests validate complete update workflow"
    - "Integration tests validate complete remove workflow"
    - "All integration tests pass without root"
  artifacts:
    - path: "updex/integration_test.go"
      provides: "End-to-end workflow tests"
      contains: "TestWorkflow"
      min_lines: 100
  key_links:
    - from: "updex/integration_test.go"
      to: "internal/testutil"
      via: "test server and helpers"
      pattern: "testutil\\."
    - from: "updex/integration_test.go"
      to: "internal/sysext"
      via: "mock runner injection"
      pattern: "sysext\\.SetRunner"
---

<objective>
Create integration tests that validate complete user workflows (install -> update -> remove) spanning multiple operations.

Purpose: Fulfills TEST-03 requirement. Catches bugs that unit tests miss by testing the interaction between operations.
Output: `updex/integration_test.go` with workflow tests that run without root.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-integration-polish/05-RESEARCH.md

# Existing test patterns to follow
@updex/update_test.go
@updex/install_test.go
@updex/remove_test.go

# Test utilities to use
@internal/testutil/http.go
@internal/sysext/manager.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create IntegrationTestEnv helper</name>
  <files>updex/integration_test.go</files>
  <action>
Create `updex/integration_test.go` with an IntegrationTestEnv struct that encapsulates:
- ConfigDir (t.TempDir() for transfer configs)
- TargetDir (t.TempDir() for extension files)
- Server (*httptest.Server from testutil.NewTestServer)
- MockRunner (*sysext.MockRunner)
- Client (*Client)
- cleanup function (registered with t.Cleanup)

Follow the pattern from 05-RESEARCH.md "IntegrationTestEnv" code example.

The helper should:
1. Create temp directories
2. Set up mock runner with sysext.SetRunner
3. Create test HTTP server with provided files
4. Create Client configured to use temp directories
5. Register cleanup function

Add a constructor: `NewIntegrationTestEnv(t *testing.T, files testutil.TestServerFiles) *IntegrationTestEnv`

Add helper method: `AddComponent(t *testing.T, name string)` that creates transfer file pointing to test server.

Reuse existing helpers `createTransferFile` and `updateTransferTargetPath` from other test files.
  </action>
  <verify>`go test -v ./updex/ -run Integration` compiles without errors</verify>
  <done>IntegrationTestEnv struct and constructor exist with proper cleanup</done>
</task>

<task type="auto">
  <name>Task 2: Create workflow integration tests</name>
  <files>updex/integration_test.go</files>
  <action>
Add three integration test functions using IntegrationTestEnv:

**TestWorkflow_UpdateWithPriorInstall:**
1. Set up env with v1 and v2 available, v1 content has matching hash
2. Create v1 file in target directory (simulating prior install)
3. Call client.Update() with NoRefresh: true
4. Assert: result shows v2 downloaded
5. Assert: v2 file exists in target directory
6. Assert: mock runner was NOT called (NoRefresh)

**TestWorkflow_InstallThenUpdate:**
1. Set up env with component index and v1, v2 files
2. Call client.Install() with test server URL and component name
3. Assert: v2 (newest) installed
4. Add v3 to server manifest
5. Call client.Update()
6. Assert: v3 downloaded
7. Assert: v3 file exists

**TestWorkflow_UpdateThenRemove:**
1. Set up env with component available
2. Call client.Update() to install
3. Call client.Remove() with NoRefresh: true
4. Assert: extension files removed from target directory
5. Assert: remove result shows success

Use table-driven subtests where appropriate. Follow existing test patterns:
- Use t.Fatalf for setup failures
- Use t.Errorf for assertion failures
- Match actual content hashes in test data (compute with sha256)
  </action>
  <verify>`go test -v ./updex/ -run TestWorkflow` shows all tests passing</verify>
  <done>Three workflow tests exist and pass, validating install/update/remove sequences</done>
</task>

<task type="auto">
  <name>Task 3: Verify integration test coverage</name>
  <files>updex/integration_test.go</files>
  <action>
Run the integration tests and verify they exercise meaningful code paths:

1. Run: `go test -v ./updex/ -run TestWorkflow`
2. Verify all three workflow tests pass
3. Run: `go test -cover ./updex/` and note coverage increase
4. If any test fails due to mock setup issues, fix by ensuring:
   - Hash values match actual content (compute sha256 at runtime like existing tests)
   - Server files map includes all required versions
   - Transfer files point to test server URL correctly

The tests should not require root privileges. All filesystem operations use t.TempDir().
All systemd operations use MockRunner.
  </action>
  <verify>`make test` passes with integration tests included</verify>
  <done>Integration tests pass, updex package coverage increased, all tests run without root</done>
</task>

</tasks>

<verification>
- `go test -v ./updex/ -run TestWorkflow` shows 3+ passing tests
- `go test ./...` passes (no regressions)
- `go test -cover ./updex/` shows > 0% coverage (improvement from 0%)
- No tests require root (all use mocks and temp dirs)
</verification>

<success_criteria>
- TEST-03 fulfilled: Integration tests validate end-to-end workflows
- At least 3 workflow tests: install sequence, update sequence, remove sequence
- Tests follow existing patterns from updex/*_test.go
- Tests run without root privileges
</success_criteria>

<output>
After completion, create `.planning/phases/05-integration-polish/05-01-SUMMARY.md`
</output>
