---
phase: 03-systemd-unit-infrastructure
plan: 03
type: execute
wave: 2
depends_on: ["03-01", "03-02"]
files_modified:
  - internal/systemd/manager.go
  - internal/systemd/manager_test.go
autonomous: true

must_haves:
  truths:
    - "Unit files can be installed to configurable path (not hardcoded)"
    - "Unit files can be removed cleanly"
    - "Timer and service files are created together (atomic operation)"
    - "daemon-reload is called after install/remove"
    - "All operations are testable with temp directories"
  artifacts:
    - path: "internal/systemd/manager.go"
      provides: "Manager with Install and Remove operations"
      exports: ["Manager", "NewManager", "NewTestManager"]
    - path: "internal/systemd/manager_test.go"
      provides: "Comprehensive tests for Manager operations"
      min_lines: 100
  key_links:
    - from: "internal/systemd/manager.go"
      to: "internal/systemd/unit.go"
      via: "calls GenerateTimer and GenerateService"
      pattern: "GenerateTimer|GenerateService"
    - from: "internal/systemd/manager.go"
      to: "internal/systemd/runner.go"
      via: "uses SystemctlRunner for daemon-reload"
      pattern: "runner\\.DaemonReload"
    - from: "internal/systemd/manager_test.go"
      to: "internal/systemd/mock_runner.go"
      via: "uses MockSystemctlRunner in tests"
      pattern: "MockSystemctlRunner"
---

<objective>
Create the Manager that handles installation and removal of systemd timer/service unit files with full testability.

Purpose: Provide the core operations for Phase 4 CLI (daemon enable/disable commands).
Output: manager.go with Install/Remove operations, comprehensive tests in manager_test.go.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-systemd-unit-infrastructure/03-RESEARCH.md
@.planning/phases/03-systemd-unit-infrastructure/03-01-SUMMARY.md
@.planning/phases/03-systemd-unit-infrastructure/03-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Manager with Install and Remove operations</name>
  <files>internal/systemd/manager.go</files>
  <action>
Create manager.go with:

1. **Manager struct:**
   ```go
   type Manager struct {
       UnitPath string          // Path to install unit files (default: /etc/systemd/system)
       runner   SystemctlRunner // For daemon-reload, enable, etc.
   }
   ```

2. **NewManager() *Manager:**
   - Returns Manager with UnitPath="/etc/systemd/system" and runner=&DefaultSystemctlRunner{}

3. **NewTestManager(unitPath string, runner SystemctlRunner) *Manager:**
   - Returns Manager with provided unitPath and runner (for testing)

4. **Install(timer *TimerConfig, service *ServiceConfig) error:**
   - Generate timer content via GenerateTimer(timer)
   - Generate service content via GenerateService(service)
   - Construct file paths: filepath.Join(m.UnitPath, timer.Name+".timer") and .service
   - Check if files already exist - return error if they do (require explicit removal first)
   - Write timer file with os.WriteFile(..., 0644)
   - Write service file with os.WriteFile(..., 0644)
   - If service write fails, remove timer file (cleanup on partial failure)
   - Call m.runner.DaemonReload()
   - Return nil on success

5. **Remove(name string) error:**
   - Construct file paths for both .timer and .service
   - Call m.runner.Stop(name + ".timer") - ignore errors (may not be running)
   - Call m.runner.Disable(name + ".timer") - ignore errors (may not be enabled)
   - Remove timer file with os.Remove() - ignore IsNotExist errors
   - Remove service file with os.Remove() - ignore IsNotExist errors
   - Call m.runner.DaemonReload()
   - Return nil on success, aggregate actual errors

6. **Exists(name string) bool:**
   - Check if either timer or service file exists at UnitPath

Use filepath.Join for path construction. Use fmt.Errorf with %w for error wrapping.
  </action>
  <verify>go build ./internal/systemd/... compiles successfully</verify>
  <done>manager.go exists with Manager, NewManager, NewTestManager, Install, Remove, Exists</done>
</task>

<task type="auto">
  <name>Task 2: Create comprehensive Manager tests</name>
  <files>internal/systemd/manager_test.go</files>
  <action>
Create manager_test.go with tests using t.TempDir() and MockSystemctlRunner:

1. **TestInstall** with cases:
   - "successful install" - creates both files, calls DaemonReload
   - "files already exist" - returns error if timer/service already present
   - "daemon-reload error" - files created but DaemonReload fails

2. **TestRemove** with cases:
   - "successful remove" - removes both files, calls Stop, Disable, DaemonReload
   - "files don't exist" - succeeds silently (idempotent)
   - "stop fails" - continues with removal anyway

3. **TestExists** with cases:
   - "timer exists" - returns true
   - "service exists" - returns true
   - "neither exists" - returns false

4. **Verification for each test:**
   - Use t.TempDir() for isolated file operations
   - Create MockSystemctlRunner to verify method calls
   - Check file existence with os.Stat()
   - Read file contents and verify they contain expected sections
   - Verify MockSystemctlRunner.DaemonReloadCalled == true after Install/Remove

5. **File content verification:**
   - After Install, read timer file and check it contains "[Timer]" and "OnCalendar"
   - After Install, read service file and check it contains "[Service]" and "ExecStart"

Follow project testing patterns from .planning/codebase/TESTING.md.
  </action>
  <verify>go test -v ./internal/systemd/... passes with all tests green</verify>
  <done>manager_test.go has 8+ test cases, all tests pass, no root required</done>
</task>

</tasks>

<verification>
```bash
# Package compiles
go build ./internal/systemd/...

# All tests pass
go test -v ./internal/systemd/...

# Coverage check (aim for >70% on manager.go)
go test -cover ./internal/systemd/...

# Full project tests still pass
make test
```
</verification>

<success_criteria>
1. internal/systemd/manager.go exists with Manager struct and operations
2. internal/systemd/manager_test.go exists with comprehensive tests
3. All tests pass without requiring root
4. Install creates both timer and service files
5. Remove cleans up both files and calls daemon-reload
6. DaemonReload is called after both Install and Remove
</success_criteria>

<output>
After completion, create `.planning/phases/03-systemd-unit-infrastructure/03-03-SUMMARY.md`
</output>
