---
phase: 03-systemd-unit-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/systemd/unit.go
  - internal/systemd/unit_test.go
autonomous: true

must_haves:
  truths:
    - "Timer unit file can be generated with valid systemd syntax"
    - "Service unit file can be generated with valid systemd syntax"
    - "Generated files include all required sections ([Unit], [Timer]/[Service], [Install])"
    - "Generation is testable with different configurations"
  artifacts:
    - path: "internal/systemd/unit.go"
      provides: "TimerConfig, ServiceConfig types and generation functions"
      exports: ["TimerConfig", "ServiceConfig", "GenerateTimer", "GenerateService"]
    - path: "internal/systemd/unit_test.go"
      provides: "Tests for unit file generation"
      min_lines: 100
  key_links:
    - from: "internal/systemd/unit_test.go"
      to: "internal/systemd/unit.go"
      via: "calls GenerateTimer and GenerateService"
      pattern: "GenerateTimer|GenerateService"
---

<objective>
Create the foundation for systemd unit file generation: types and functions that generate valid timer and service unit file content.

Purpose: Enable programmatic generation of systemd timer/service files for scheduling automatic updates.
Output: internal/systemd/unit.go with types and generation functions, comprehensive tests in unit_test.go.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-systemd-unit-infrastructure/03-RESEARCH.md
@internal/sysext/runner.go (pattern reference for interface design)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create unit types and generation functions</name>
  <files>internal/systemd/unit.go</files>
  <action>
Create new package `internal/systemd` with unit.go containing:

1. **TimerConfig struct** with fields:
   - Name string (e.g., "updex-update")
   - Description string (e.g., "Automatic sysext updates")
   - OnCalendar string (e.g., "daily" or "*-*-* 04:00:00")
   - Persistent bool (run if missed)
   - RandomDelaySec int (randomize start within this window in seconds)

2. **ServiceConfig struct** with fields:
   - Name string
   - Description string
   - ExecStart string (full command, e.g., "/usr/bin/updex update --quiet")
   - Type string (default to "oneshot")

3. **GenerateTimer(cfg *TimerConfig) string** function:
   - Generate [Unit] section with Description
   - Generate [Timer] section with OnCalendar, optional Persistent=true, optional RandomizedDelaySec
   - Generate [Install] section with WantedBy=timers.target
   - Use strings.Builder for efficient string building (not text/template - simpler for this use case)

4. **GenerateService(cfg *ServiceConfig) string** function:
   - Generate [Unit] section with Description
   - Generate [Service] section with Type and ExecStart
   - No [Install] section needed (timer handles activation)

Use the exact patterns from 03-RESEARCH.md Code Examples section. Include package doc comment explaining purpose.
  </action>
  <verify>go build ./internal/systemd/... compiles successfully</verify>
  <done>unit.go exists with TimerConfig, ServiceConfig, GenerateTimer, GenerateService exported</done>
</task>

<task type="auto">
  <name>Task 2: Create comprehensive unit generation tests</name>
  <files>internal/systemd/unit_test.go</files>
  <action>
Create unit_test.go with table-driven tests following project conventions:

1. **TestGenerateTimer** with cases:
   - "minimal config" - only required fields (Name, Description, OnCalendar)
   - "with persistent" - Persistent=true adds "Persistent=true" line
   - "with random delay" - RandomDelaySec=3600 adds "RandomizedDelaySec=3600s"
   - "full config" - all options enabled

2. **TestGenerateService** with cases:
   - "minimal config" - Name, Description, ExecStart, Type
   - "oneshot type" - Type="oneshot"

3. **Verification approach for each test:**
   - Check that output contains expected section headers ("[Unit]", "[Timer]", etc.)
   - Check that Description line is present
   - Check that OnCalendar/ExecStart values are correct
   - Use strings.Contains for flexible matching (not exact string equality - allows formatting flexibility)

Follow project testing patterns from .planning/codebase/TESTING.md:
- Table-driven tests with t.Run
- Descriptive test case names
- Use t.Errorf for assertion failures
  </action>
  <verify>go test -v ./internal/systemd/... passes with all tests green</verify>
  <done>unit_test.go has 6+ test cases covering all generation paths, all tests pass</done>
</task>

</tasks>

<verification>
```bash
# Package compiles
go build ./internal/systemd/...

# All tests pass
go test -v ./internal/systemd/...

# Coverage check
go test -cover ./internal/systemd/...
```
</verification>

<success_criteria>
1. internal/systemd/unit.go exists with exported types and functions
2. internal/systemd/unit_test.go exists with comprehensive tests
3. All tests pass
4. Generated unit content contains valid systemd sections
</success_criteria>

<output>
After completion, create `.planning/phases/03-systemd-unit-infrastructure/03-01-SUMMARY.md`
</output>
