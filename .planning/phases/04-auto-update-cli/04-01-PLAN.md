---
phase: 04-auto-update-cli
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - cmd/commands/daemon.go
  - cmd/updex/root.go
  - cmd/commands/update.go
autonomous: true

must_haves:
  truths:
    - "User can run `updex daemon enable` to install timer/service files"
    - "User can run `updex daemon disable` to remove timer/service files"
    - "User can run `updex daemon status` to check timer state"
    - "User can run `updex update --reboot` to reboot after update"
    - "Daemon service uses --no-refresh to stage files only"
  artifacts:
    - path: "cmd/commands/daemon.go"
      provides: "daemon command with enable/disable/status subcommands"
      min_lines: 150
    - path: "cmd/updex/root.go"
      provides: "daemon command registration"
      contains: "NewDaemonCmd"
    - path: "cmd/commands/update.go"
      provides: "--reboot flag implementation"
      contains: "reboot"
  key_links:
    - from: "cmd/commands/daemon.go"
      to: "internal/systemd.Manager"
      via: "NewManager() and Install/Remove/Exists calls"
      pattern: "systemd\\.NewManager\\(\\)"
    - from: "cmd/commands/daemon.go"
      to: "internal/systemd.DefaultSystemctlRunner"
      via: "Enable/Start/IsActive/IsEnabled calls"
      pattern: "DefaultSystemctlRunner"
    - from: "cmd/updex/root.go"
      to: "cmd/commands.NewDaemonCmd"
      via: "AddCommand registration"
      pattern: "NewDaemonCmd\\(\\)"
---

<objective>
Create CLI commands for managing the auto-update daemon and add --reboot flag to update command.

Purpose: This exposes the Phase 3 systemd infrastructure via user-facing CLI commands, allowing users to enable/disable automatic updates and optionally reboot after manual updates.

Output: Working `updex daemon enable|disable|status` commands and `updex update --reboot` flag.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase 3 provides the systemd infrastructure we're wiring to
@.planning/phases/03-systemd-unit-infrastructure/03-03-SUMMARY.md

# Pattern to follow exactly
@cmd/commands/features.go

# Files to modify
@cmd/commands/update.go
@cmd/updex/root.go

# Systemd infrastructure we're using
@internal/systemd/manager.go
@internal/systemd/runner.go
@internal/systemd/unit.go

# Common utilities
@cmd/common/common.go

# Research with patterns and examples
@.planning/phases/04-auto-update-cli/04-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create daemon command with enable/disable/status subcommands</name>
  <files>cmd/commands/daemon.go</files>
  <action>
Create `cmd/commands/daemon.go` following the exact pattern from `features.go`:

1. Define `const unitName = "updex-update"` for consistent naming

2. Create `NewDaemonCmd()` that returns a `*cobra.Command`:
   - Use: "daemon"
   - Short: "Manage auto-update daemon"
   - Long: Describe what daemon does, that updates are staged not activated
   - AddCommand for enable, disable, status subcommands

3. Create `newDaemonEnableCmd()`:
   - Use: "enable", Short: "Enable automatic updates"
   - Args: cobra.NoArgs
   - RunE: runDaemonEnable

4. Implement `runDaemonEnable`:
   - Call common.RequireRoot() first
   - Create systemd.NewManager()
   - Check mgr.Exists(unitName) - if true, return error "already installed"
   - Create TimerConfig: Name=unitName, Description="Automatic sysext updates", OnCalendar="daily", Persistent=true, RandomDelaySec=3600
   - Create ServiceConfig: Name=unitName, Description="Automatic sysext update service", ExecStart="/usr/bin/updex update --no-refresh", Type="oneshot"
   - Call mgr.Install(timer, service)
   - Create DefaultSystemctlRunner{}, call Enable(unitName+".timer") and Start(unitName+".timer")
   - Handle common.JSONOutput for JSON mode
   - Print success message: "Auto-update daemon enabled..."

5. Create `newDaemonDisableCmd()`:
   - Use: "disable", Short: "Disable automatic updates"
   - Args: cobra.NoArgs
   - RunE: runDaemonDisable

6. Implement `runDaemonDisable`:
   - Call common.RequireRoot() first
   - Create systemd.NewManager()
   - Check !mgr.Exists(unitName) - if true, return error "not installed"
   - Call mgr.Remove(unitName) (this handles stop/disable/remove/daemon-reload)
   - Handle common.JSONOutput for JSON mode
   - Print success message: "Auto-update daemon disabled..."

7. Create `newDaemonStatusCmd()`:
   - Use: "status", Short: "Show daemon status"
   - Args: cobra.NoArgs
   - RunE: runDaemonStatus

8. Define DaemonStatus struct:
   ```go
   type DaemonStatus struct {
       Installed bool   `json:"installed"`
       Enabled   bool   `json:"enabled"`
       Active    bool   `json:"active"`
       Schedule  string `json:"schedule,omitempty"`
   }
   ```

9. Implement `runDaemonStatus`:
   - Create manager and runner
   - status.Installed = mgr.Exists(unitName)
   - If installed, check runner.IsEnabled/IsActive for unitName+".timer"
   - status.Schedule = "daily" (fixed for now)
   - Handle common.JSONOutput for JSON mode
   - Print text status with installed/enabled/active/schedule

Import: "github.com/frostyard/updex/internal/systemd" along with existing imports pattern from features.go.

Follow error wrapping pattern: fmt.Errorf("failed to X: %w", err)
  </action>
  <verify>
Run: `go build ./...` - compiles without errors
Run: `go vet ./cmd/commands/daemon.go` - no issues
  </verify>
  <done>
daemon.go exists with NewDaemonCmd() that creates enable/disable/status subcommands.
All three subcommands have proper RunE implementations using systemd.Manager and SystemctlRunner.
Service ExecStart includes "--no-refresh" for AUTO-04 requirement.
  </done>
</task>

<task type="auto">
  <name>Task 2: Register daemon command and add --reboot flag to update</name>
  <files>cmd/updex/root.go, cmd/commands/update.go</files>
  <action>
**In cmd/updex/root.go:**

Add `rootCmd.AddCommand(commands.NewDaemonCmd())` in the init() function, after the existing command registrations (after NewInstallCmd line).

**In cmd/commands/update.go:**

1. Add package-level var for reboot flag:
   ```go
   var (
       noVacuum bool
       reboot   bool
   )
   ```

2. Add flag registration in NewUpdateCmd():
   ```go
   cmd.Flags().BoolVar(&reboot, "reboot", false, "Reboot system after successful update")
   ```

3. Update the Long description to mention --reboot:
   ```go
   Long: `Download and install the newest available version, or a specific version if specified.

After installation, old versions are automatically removed according to InstancesMax
unless --no-vacuum is specified.

With --reboot flag, the system will reboot after a successful update to activate
the new extensions.`,
   ```

4. Add import for "os/exec" at the top of the file.

5. At the end of runUpdate, before the final `return err`, add:
   ```go
   // Reboot if requested and updates were installed
   if reboot && anyInstalled && err == nil {
       if !common.JSONOutput {
           fmt.Println("\nRebooting system to activate changes...")
       }
       return exec.Command("systemctl", "reboot").Run()
   }
   ```

Note: The reboot check comes after the "Reboot required" message print, replacing the final return.
  </action>
  <verify>
Run: `go build ./...` - compiles without errors
Run: `updex --help` - shows "daemon" in command list
Run: `updex daemon --help` - shows enable/disable/status subcommands
Run: `updex update --help` - shows --reboot flag
  </verify>
  <done>
- daemon command appears in `updex --help`
- `updex daemon enable/disable/status` subcommands are accessible
- `updex update --reboot` flag is documented and implemented
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Build verification:
   ```bash
   go build ./...
   go test ./...
   ```

2. Command structure verification:
   ```bash
   ./updex daemon --help
   # Should show: enable, disable, status subcommands
   
   ./updex daemon enable --help
   # Should mention root privileges required
   
   ./updex daemon status
   # Should show "not installed" (or requires root error)
   
   ./updex update --help
   # Should show --reboot flag
   ```

3. Code verification:
   - daemon.go uses systemd.NewManager() for Install/Remove/Exists
   - daemon.go uses DefaultSystemctlRunner for Enable/Start/IsActive/IsEnabled  
   - Service ExecStart contains "--no-refresh" (AUTO-04)
   - update.go has reboot logic gated by anyInstalled && err == nil
</verification>

<success_criteria>
- [ ] `go build ./...` succeeds
- [ ] `go test ./...` passes
- [ ] `updex daemon enable --help` shows command description
- [ ] `updex daemon disable --help` shows command description
- [ ] `updex daemon status` shows status or root error
- [ ] `updex update --help` shows --reboot flag
- [ ] Service ExecStart in daemon.go includes "--no-refresh"
- [ ] Reboot only triggers when anyInstalled && err == nil
</success_criteria>

<output>
After completion, create `.planning/phases/04-auto-update-cli/04-01-SUMMARY.md`
</output>
